# Makefile para deploy do Versiona AI

.PHONY: help build up down logs clean restart

# VariÃ¡veis
COMPOSE_FILE = docker-compose.simple.yml
COMPOSE_FILE_FULL = docker-compose.yml

help: ## Mostrar ajuda
	@echo "ğŸš€ Deploy do Versiona AI"
	@echo ""
	@echo "Comandos disponÃ­veis:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

setup: ## Configurar ambiente inicial
	@echo "ğŸ“‹ Configurando ambiente..."
	@cp -n .env.example .env || true
	@echo "âœ… Arquivo .env criado (edite com suas configuraÃ§Ãµes)"
	@mkdir -p data/{logs,results,temp}
	@echo "âœ… DiretÃ³rios de dados criados"

build: ## Construir imagem Docker
	@echo "ğŸ”¨ Construindo imagem..."
	@docker-compose -f $(COMPOSE_FILE) build

up: ## Iniciar serviÃ§os (simples)
	@echo "ğŸš€ Iniciando Versiona AI..."
	@docker-compose -f $(COMPOSE_FILE) up -d
	@echo "âœ… ServiÃ§os iniciados!"
	@echo "ğŸŒ Frontend: http://localhost:3000"
	@echo "ğŸ”Œ API: http://localhost:8000"

up-full: ## Iniciar serviÃ§os completos (com Nginx)
	@echo "ğŸš€ Iniciando Versiona AI completo..."
	@docker-compose -f $(COMPOSE_FILE_FULL) up -d
	@echo "âœ… ServiÃ§os iniciados!"
	@echo "ğŸŒ Acesse: http://localhost:80"

down: ## Parar serviÃ§os
	@echo "â¹ï¸  Parando serviÃ§os..."
	@docker-compose -f $(COMPOSE_FILE) down
	@docker-compose -f $(COMPOSE_FILE_FULL) down 2>/dev/null || true

logs: ## Ver logs
	@docker-compose -f $(COMPOSE_FILE) logs -f

status: ## Ver status dos containers
	@echo "ğŸ“Š Status dos containers:"
	@docker-compose -f $(COMPOSE_FILE) ps

health: ## Verificar saÃºde da aplicaÃ§Ã£o
	@echo "ğŸ©º Verificando saÃºde..."
	@curl -f http://localhost:8000/health || echo "âŒ API nÃ£o estÃ¡ respondendo"
	@curl -f http://localhost:3000/ >/dev/null 2>&1 || echo "âŒ Frontend nÃ£o estÃ¡ respondendo"

restart: ## Reiniciar serviÃ§os
	@echo "ğŸ”„ Reiniciando..."
	@make down
	@make up

clean: ## Limpar containers e imagens
	@echo "ğŸ§¹ Limpando..."
	@docker-compose -f $(COMPOSE_FILE) down -v --remove-orphans
	@docker-compose -f $(COMPOSE_FILE_FULL) down -v --remove-orphans 2>/dev/null || true
	@docker system prune -f

rebuild: ## Rebuild completo
	@echo "ğŸ”„ Rebuild completo..."
	@make down
	@make build
	@make up

dev: ## Modo desenvolvimento (logs em tempo real)
	@echo "ğŸ› ï¸  Modo desenvolvimento..."
	@docker-compose -f $(COMPOSE_FILE) up --build

prod: ## Deploy de produÃ§Ã£o
	@echo "ğŸ­ Deploy de produÃ§Ã£o..."
	@make setup
	@make build
	@make up-full

# Comandos de debug
shell-api: ## Entrar no container da API
	@docker exec -it versiona-ai-api bash

shell-web: ## Entrar no container do frontend
	@docker exec -it versiona-ai-web sh

shell: shell-api ## Alias para shell-api

debug-logs: ## Ver logs detalhados
	@echo "ğŸ“‹ Logs do Gunicorn Access:"
	@docker exec versiona-ai-api tail -f /app/logs/gunicorn_access.log &
	@echo "ğŸ“‹ Logs do Gunicorn Error:"
	@docker exec versiona-ai-api tail -f /app/logs/gunicorn_error.log

test-api: ## Testar API
	@echo "ğŸ§ª Testando API..."
	@curl -s http://localhost:8000/health | jq . || echo "âŒ Falha no teste"
	@curl -s http://localhost:8000/api/status | jq . || echo "âŒ Falha no status"
